<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
      <meta name="tags" content="Interactive, MindMap">
  <title>Conceptual Atlas – 101 concepts (zoom • drag • highlight • search)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root { --sidebar-w: 360px; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #f3f4f6;
    }
    body {
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      overflow: hidden;
    }
    /* Sidebar */
    #sidebar {
      background: #fff;
      border-right: 1px solid #e5e7eb;
      padding: 16px;
      overflow-y: auto;
    }
    #sidebar h2 { margin: 0 0 8px; font-size: 1.15rem; }
    #count { display:inline-block; margin-left:8px; font-size:.85rem; color:#6b7280;}
    #sidebar p { font-size: 0.92rem; line-height: 1.45; }
    /* Search */
    #search-wrap { display:flex; gap:6px; margin:8px 0 10px; }
    #search { flex:1; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; font-size:.95rem; }
    #clear-btn { padding:8px 10px; border:1px solid #d1d5db; background:#fff; border-radius:8px; font-size:.9rem; cursor:pointer; }
    /* Legend */
    .legend { background:#fff; border:1px solid #ddd; border-radius:6px; padding:6px 8px; font-size:12px; max-width:320px; }
    .legend-item { display:flex; align-items:center; gap:6px; margin-bottom:4px; line-height:1.2; cursor:pointer; }
    .legend-swatch { width:12px; height:12px; border-radius:999px; }
    /* Main panel */
    #main { padding: 12px; }
    #map-panel {
      position: relative; width: 100%; height: calc(100vh - 24px);
      background:#fff; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;
    }
    .tooltip {
      position:absolute; background:#fff; border:1px solid #ccc; border-radius:6px;
      padding:4px 8px; font-size:11px; pointer-events:none; opacity:0;
      box-shadow:0 2px 4px rgba(0,0,0,.12);
    }
    .label { font-size: 11px; fill:#2b2b2b; pointer-events:none; user-select:none; font-weight:500; text-shadow:0 1px 2px #fff; }
    .hint {
      position:absolute; right:10px; bottom:10px; font-size:12px; color:#6b7280;
      background:rgba(255,255,255,.9); border:1px solid #e5e7eb; border-radius:6px; padding:4px 8px;
    }
    /* Panning cursor */
    .pan-bg { cursor: grab; }
    .pan-bg.grabbing { cursor: grabbing; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Conceptual Atlas <span id="count"></span></h2>
    <div id="search-wrap">
      <input id="search" type="search" placeholder="Search concepts or categories…" />
      <button id="clear-btn" title="Clear search">Clear</button>
    </div>
    <p><em>Click a node to see details.</em> Pan: drag the white background • Zoom: scroll • Drag nodes to arrange.</p>
    <p>This demo maps <strong>universal constructs</strong> across identity, learning, systems, bias, communication, and social lenses.</p>
    <div id="legend" class="legend"></div>
    <div id="details"></div>
  </div>

  <div id="main">
    <div id="map-panel">
      <svg id="chart" width="100%" height="100%"></svg>
      <div id="tooltip" class="tooltip"></div>
      <div class="hint">Pan: drag background • Zoom: scroll • Drag nodes to adjust</div>
    </div>
  </div>

  <script>
    // ========= 1) DATA (raw, may contain accidental duplicates) =========
    const conceptsRaw = [
      /* --- Core set (identity, learning, systems, bias, social, comms) --- */
      { name:"Imposter Syndrome", category:"Identity & Motivation", description:"Persistent belief that one’s success is undeserved despite evidence of competence.", connections:["Self-Efficacy","Growth Mindset","Social Comparison Theory"] },
      { name:"Self-Efficacy", category:"Identity & Motivation", description:"Belief in one’s ability to execute actions required to achieve goals.", connections:["Imposter Syndrome","Growth Mindset","Locus of Control"] },
      { name:"Growth Mindset", category:"Learning & Adaptation", description:"Abilities can be developed through effort, strategies, and feedback.", connections:["Self-Efficacy","Neuroplasticity","Feedback Loop","Plasticity"] },
      { name:"Neuroplasticity", category:"Learning & Adaptation", description:"The brain’s ability to reorganize by forming new connections.", connections:["Growth Mindset","Resilience","Cognitive Reappraisal","Metacognition","Plasticity"] },
      { name:"Resilience", category:"Emotion & Regulation", description:"Capacity to recover from difficulties and adapt positively to change.", connections:["Neuroplasticity","Mindfulness","Flow","Belongingness","Burnout"] },
      { name:"Mindfulness", category:"Emotion & Regulation", description:"Nonjudgmental awareness of the present moment.", connections:["Resilience","Cognitive Reappraisal","Flow","Emotional Intelligence","Burnout"] },
      { name:"Cognitive Reappraisal", category:"Emotion & Regulation", description:"Reinterpreting a situation to alter its emotional impact.", connections:["Neuroplasticity","Mindfulness","Metacognition","Socratic Questioning","Dialectical Thinking"] },
      { name:"Flow", category:"Creativity & Design", description:"Deep immersion where challenge and skill are balanced.", connections:["Resilience","Mindfulness","Divergent Thinking","Lateral Thinking"] },
      { name:"Divergent Thinking", category:"Creativity & Design", description:"Generating multiple non-linear ideas or solutions.", connections:["Flow","Systems Thinking","Metacognition","Lateral Thinking"] },
      { name:"Systems Thinking", category:"Systems & Change", description:"Understanding interrelations and emergent behavior.", connections:["Divergent Thinking","Feedback Loop","Media Literacy","Double-Loop Learning","Dialectical Thinking"] },
      { name:"Social Comparison Theory", category:"Social & Cultural", description:"We evaluate ourselves by comparison to others.", connections:["Imposter Syndrome","Belongingness","Media Literacy","Narrative Framing"] },
      { name:"Locus of Control", category:"Identity & Motivation", description:"Internal vs external beliefs about causality of outcomes.", connections:["Self-Efficacy","Growth Mindset","Intrinsic vs Extrinsic Motivation"] },
      { name:"Feedback Loop", category:"Systems & Change", description:"Outputs fed back as inputs; balancing or reinforcing.", connections:["Growth Mindset","Systems Thinking","Metacognition","Double-Loop Learning"] },
      { name:"Metacognition", category:"Learning & Adaptation", description:"Monitoring and regulating one’s own cognition.", connections:["Cognitive Reappraisal","Neuroplasticity","Divergent Thinking","Feedback Loop","Socratic Questioning","First Principles Thinking","Plasticity"] },
      { name:"Media Literacy", category:"Knowledge & Communication", description:"Access, analyze, evaluate, and create media.", connections:["Social Comparison Theory","Systems Thinking","Confirmation Bias","Narrative Framing","Logical Fallacies"] },
      { name:"Inclusivity", category:"Social & Cultural", description:"Design environments where diverse people feel valued.", connections:["Belongingness","Intersectionality","Allyship","Psychological Safety"] },
      { name:"Belongingness", category:"Social & Cultural", description:"Need to feel accepted as part of a group.", connections:["Resilience","Social Comparison Theory","Inclusivity","Psychological Safety"] },
      { name:"Intersectionality", category:"Social & Cultural", description:"Overlapping identities shape lived experience.", connections:["Inclusivity","Media Literacy","Cultural Competence"] },
      { name:"Confirmation Bias", category:"Cognition & Bias", description:"Seek/interpret info that confirms existing beliefs.", connections:["Media Literacy","Anchoring Bias","Logical Fallacies"] },
      { name:"Anchoring Bias", category:"Cognition & Bias", description:"Overweight first information encountered.", connections:["Confirmation Bias"] },
      { name:"Moral Dilemmas", category:"Ethics & Reasoning", description:"Competing moral principles require judgment.", connections:["Dialectical Thinking","Perspective-Taking","Cultural Competence"] },
      { name:"Logical Fallacies", category:"Cognition & Bias", description:"Flaws in reasoning undermining arguments.", connections:["Media Literacy","Confirmation Bias","Socratic Questioning"] },
      { name:"Narrative Framing", category:"Knowledge & Communication", description:"How information is told shapes understanding.", connections:["Media Literacy","Confirmation Bias","Social Comparison Theory"] },
      { name:"First Principles Thinking", category:"Creativity & Design", description:"Reduce to fundamentals and build up.", connections:["Metacognition","Systems Thinking"] },
      { name:"Socratic Questioning", category:"Learning & Adaptation", description:"Disciplined questioning to surface assumptions.", connections:["Metacognition","Cognitive Reappraisal","Logical Fallacies"] },
      { name:"Dialectical Thinking", category:"Learning & Adaptation", description:"Hold and integrate opposing ideas.", connections:["Systems Thinking","Cognitive Reappraisal","Moral Dilemmas"] },
      { name:"Lateral Thinking", category:"Creativity & Design", description:"Approach problems indirectly with fresh angles.", connections:["Divergent Thinking","Flow"] },
      { name:"Double-Loop Learning", category:"Systems & Change", description:"Fix problems and question the underlying goals.", connections:["Feedback Loop","Systems Thinking","Metacognition"] },
      { name:"Perspective-Taking", category:"Social & Cultural", description:"See from another’s viewpoint.", connections:["Empathy","Cultural Competence","Theory of Mind","Moral Dilemmas"] },
      { name:"Cultural Competence", category:"Social & Cultural", description:"Interact effectively across cultures.", connections:["Intersectionality","Inclusivity","Perspective-Taking"] },
      { name:"Empathy", category:"Social & Cultural", description:"Understand and share feelings of others.", connections:["Perspective-Taking","Active Listening","Emotional Intelligence"] },
      { name:"Active Listening", category:"Social & Cultural", description:"Listen to understand, not to reply.", connections:["Empathy","Conflict Resolution"] },
      { name:"Conflict Resolution", category:"Social & Cultural", description:"Resolve disagreements while preserving relationships.", connections:["Active Listening","Psychological Safety","Allyship"] },
      { name:"Allyship", category:"Social & Cultural", description:"Use position to advocate for marginalized groups.", connections:["Inclusivity","Belongingness","Conflict Resolution"] },
      { name:"Emotional Intelligence", category:"Emotion & Regulation", description:"Recognize and manage emotions in self/others.", connections:["Mindfulness","Empathy","Psychological Safety"] },
      { name:"Psychological Safety", category:"Social & Cultural", description:"Safe for interpersonal risk-taking.", connections:["Belongingness","Inclusivity","Emotional Intelligence","Conflict Resolution"] },
      { name:"Burnout", category:"Emotion & Regulation", description:"Exhaustion from prolonged stress.", connections:["Mindfulness","Resilience"] },
      { name:"Intrinsic vs Extrinsic Motivation", category:"Identity & Motivation", description:"Inherent satisfaction vs external rewards.", connections:["Self-Efficacy","Locus of Control"] },
      { name:"Theory of Mind", category:"Learning & Adaptation", description:"Others have distinct beliefs and desires.", connections:["Perspective-Taking","Empathy"] },
      { name:"Plasticity", category:"Learning & Adaptation", description:"General capacity to adapt with experience.", connections:["Neuroplasticity","Growth Mindset","Metacognition"] },

      /* --- Next 20 (to 80) --- */
      { name:"Opportunity Cost", category:"Ethics & Reasoning", description:"What you forgo when choosing an option.", connections:["Cost-Benefit Analysis","Systems Thinking","First Principles Thinking"] },
      { name:"Pareto Principle (80/20)", category:"Systems & Change", description:"Minority of causes drive majority of outcomes.", connections:["Systems Thinking","Opportunity Cost"] },
      { name:"Sunk Cost Fallacy", category:"Cognition & Bias", description:"Continue due to past investment, not future value.", connections:["Confirmation Bias","Anchoring Bias","Burnout"] },
      { name:"Availability Heuristic", category:"Cognition & Bias", description:"Judge likelihood by ease of recall.", connections:["Media Literacy","Recency Effect","Confirmation Bias"] },
      { name:"Recency Effect", category:"Cognition & Bias", description:"Recent info weighs more than earlier info.", connections:["Availability Heuristic","Media Literacy"] },
      { name:"Fundamental Attribution Error", category:"Cognition & Bias", description:"Over-attribute to disposition over situation.", connections:["Perspective-Taking","Empathy","Logical Fallacies"] },
      { name:"Social Proof", category:"Social & Cultural", description:"Assume behavior is correct because others do it.", connections:["Media Literacy","Narrative Framing","Confirmation Bias"] },
      { name:"Survivorship Bias", category:"Cognition & Bias", description:"Focus on visible survivors; ignore failures.", connections:["Media Literacy","Confirmation Bias","Logical Fallacies"] },
      { name:"Emergent Properties", category:"Systems & Change", description:"System behaviors not obvious from parts.", connections:["Systems Thinking","Feedback Loop","Double-Loop Learning"] },
      { name:"Entropy", category:"Systems & Change", description:"Tendency toward disorder/decay.", connections:["Systems Thinking","Feedback Loop"] },
      { name:"Occam’s Razor", category:"Ethics & Reasoning", description:"Prefer simpler explanations that fit evidence.", connections:["First Principles Thinking","Logical Fallacies","Media Literacy"] },
      { name:"Game Theory", category:"Ethics & Reasoning", description:"Strategy where outcomes depend on others.", connections:["Moral Dilemmas","Perspective-Taking"] },
      { name:"Cost-Benefit Analysis", category:"Ethics & Reasoning", description:"Weigh expected gains vs costs.", connections:["Opportunity Cost","First Principles Thinking","Moral Dilemmas"] },
      { name:"Scientific Uncertainty", category:"Knowledge & Communication", description:"Evidence is probabilistic and revisable.", connections:["Media Literacy","Statistical Significance","Hypothesis Testing"] },
      { name:"Statistical Significance", category:"Knowledge & Communication", description:"Are effects likely beyond chance?", connections:["Scientific Uncertainty","Hypothesis Testing"] },
      { name:"Hypothesis Testing", category:"Knowledge & Communication", description:"Formulate, test, and update beliefs with data.", connections:["Scientific Uncertainty","Statistical Significance"] },
      { name:"Cognitive Dissonance", category:"Cognition & Bias", description:"Discomfort from conflicting beliefs/behaviors.", connections:["Confirmation Bias","Moral Dilemmas","Cognitive Reappraisal"] },
      { name:"Heuristics & Biases (Umbrella)", category:"Cognition & Bias", description:"The family of shortcuts and pitfalls.", connections:["Availability Heuristic","Anchoring Bias","Confirmation Bias"] },
      { name:"Signal vs Noise", category:"Knowledge & Communication", description:"Separate meaningful patterns from randomness.", connections:["Scientific Uncertainty","Hypothesis Testing","Media Literacy"] },
      { name:"Trade-offs", category:"Ethics & Reasoning", description:"Prioritize among incompatible goods.", connections:["Opportunity Cost","Cost-Benefit Analysis","First Principles Thinking"] },

      /* --- Final 21 (to 101) --- */
      { name:"Correlation vs Causation", category:"Knowledge & Communication", description:"Correlation does not imply causation.", connections:["Scientific Uncertainty","Hypothesis Testing","Logical Fallacies","Media Literacy"] },
      { name:"Base Rate Neglect", category:"Cognition & Bias", description:"Ignoring priors when judging likelihoods.", connections:["Statistical Significance","Scientific Uncertainty","Confirmation Bias"] },
      { name:"Regression to the Mean", category:"Knowledge & Communication", description:"Extremes are followed by more typical outcomes.", connections:["Statistical Significance","Scientific Uncertainty","Signal vs Noise"] },
      { name:"Simpson's Paradox", category:"Knowledge & Communication", description:"Aggregated trends can reverse group trends.", connections:["Statistical Significance","Scientific Uncertainty","Media Literacy"] },
      { name:"Expected Value", category:"Ethics & Reasoning", description:"Probability-weighted average outcome.", connections:["Cost-Benefit Analysis","Opportunity Cost","Game Theory"] },
      { name:"Bayesian Reasoning", category:"Knowledge & Communication", description:"Update beliefs via priors and new evidence.", connections:["Hypothesis Testing","Scientific Uncertainty","Media Literacy"] },
      { name:"Risk vs Uncertainty", category:"Ethics & Reasoning", description:"Known odds vs unknown odds; decisions differ.", connections:["Scientific Uncertainty","Cost-Benefit Analysis","Game Theory"] },
      { name:"Incentives", category:"Systems & Change", description:"Rewards/penalties shaping behavior.", connections:["Game Theory","Trade-offs","Opportunity Cost"] },
      { name:"Principal–Agent Problem", category:"Systems & Change", description:"Misaligned goals between principals and agents.", connections:["Incentives","Game Theory","Moral Dilemmas"] },
      { name:"Externalities", category:"Systems & Change", description:"Third-party costs/benefits of actions.", connections:["Trade-offs","Cost-Benefit Analysis","Systems Thinking"] },
      { name:"Network Effects", category:"Systems & Change", description:"Value rises with number of users.", connections:["Social Proof","Systems Thinking","Emergent Properties"] },
      { name:"Path Dependence", category:"Systems & Change", description:"Early choices constrain future options.", connections:["Systems Thinking","Entropy","Emergent Properties"] },
      { name:"Temporal Discounting", category:"Cognition & Bias", description:"Prefer sooner-smaller vs later-larger rewards.", connections:["Intrinsic vs Extrinsic Motivation","Opportunity Cost","Cost-Benefit Analysis"] },
      { name:"Cognitive Load", category:"Learning & Adaptation", description:"Mental effort required to process.", connections:["Metacognition","Mindfulness","Media Literacy"] },
      { name:"Chunking", category:"Learning & Adaptation", description:"Group items into meaningful units.", connections:["Cognitive Load","Metacognition","Spaced Repetition"] },
      { name:"Spaced Repetition", category:"Learning & Adaptation", description:"Review with increasing intervals.", connections:["Metacognition","Cognitive Load","Chunking"] },
      { name:"Transfer of Learning", category:"Learning & Adaptation", description:"Apply knowledge across contexts.", connections:["Metacognition","Systems Thinking","First Principles Thinking"] },
      { name:"Analogy", category:"Creativity & Design", description:"Map structure from known to new domains.", connections:["First Principles Thinking","Divergent Thinking","Narrative Framing"] },
      { name:"Map–Territory Distinction", category:"Knowledge & Communication", description:"Models are not reality.", connections:["Media Literacy","Scientific Uncertainty","Systems Thinking"] },
      { name:"Orders of Magnitude", category:"Knowledge & Communication", description:"Reason across powers of ten.", connections:["Signal vs Noise","Scientific Uncertainty","Hypothesis Testing"] },
      { name:"Long Tail", category:"Systems & Change", description:"Many niches rival or exceed a few hits.", connections:["Pareto Principle (80/20)","Network Effects","Narrative Framing"] }

,
{ name: "Counterfactual Reasoning", category: "Ethics & Reasoning", description: "Thinking in 'what if' terms to assess causality and decisions.", connections: ["Correlation vs Causation","Hypothesis Testing","Bayesian Reasoning"] },
{ name: "Root Cause Analysis (5 Whys)", category: "Systems & Change", description: "Iteratively probing to uncover underlying causes of problems.", connections: ["First Principles Thinking","Feedback Loop","Systems Thinking"] },
{ name: "Diminishing Returns", category: "Systems & Change", description: "Each additional input yields progressively smaller gains.", connections: ["Trade-offs","Opportunity Cost","Pareto Principle (80/20)"] },
{ name: "Leverage Points", category: "Systems & Change", description: "Places within a system where small shifts produce big changes.", connections: ["Systems Thinking","Feedback Loop","Emergent Properties"] },
{ name: "Time Lags & Delays", category: "Systems & Change", description: "Effects that occur after a delay, often obscuring feedback.", connections: ["Feedback Loop","Systems Thinking","Entropy"] },
{ name: "Robustness vs Fragility", category: "Systems & Change", description: "Stability under stress versus vulnerability to shocks.", connections: ["Resilience","Risk vs Uncertainty","Entropy"] },
{ name: "Tragedy of the Commons", category: "Systems & Change", description: "Individually rational use depletes shared resources.", connections: ["Externalities","Game Theory","Moral Dilemmas"] },
{ name: "Overfitting vs Underfitting", category: "Knowledge & Communication", description: "Too closely vs too loosely matching data patterns.", connections: ["Hypothesis Testing","Signal vs Noise","Scientific Uncertainty"] },
{ name: "Curse of Dimensionality", category: "Knowledge & Communication", description: "High-dimensional spaces make patterns sparser and harder to learn.", connections: ["Orders of Magnitude","Signal vs Noise","Hypothesis Testing"] },
{ name: "Measurement Error", category: "Knowledge & Communication", description: "Noise and bias introduced by imperfect instruments or methods.", connections: ["Scientific Uncertainty","Media Literacy","Hypothesis Testing"] },
{ name: "Hindsight Bias", category: "Cognition & Bias", description: "Seeing past events as having been predictable.", connections: ["Confirmation Bias","Narrative Framing"] },
{ name: "Planning Fallacy", category: "Cognition & Bias", description: "Underestimating time/costs despite prior experience.", connections: ["Temporal Discounting","Cognitive Load"] },
{ name: "Critical Periods", category: "Learning & Adaptation", description: "Time windows when learning or change is especially effective.", connections: ["Plasticity","Neuroplasticity","Metacognition"] },
{ name: "Memory Interference", category: "Learning & Adaptation", description: "New/old learning disrupts recall of other material.", connections: ["Cognitive Load","Spaced Repetition","Chunking"] },
{ name: "Abstraction Levels", category: "Knowledge & Communication", description: "Reasoning across concrete to abstract representations.", connections: ["Map–Territory Distinction","First Principles Thinking","Orders of Magnitude"] },
{ name: "Modularity", category: "Systems & Change", description: "Decomposing systems into parts that combine flexibly.", connections: ["Systems Thinking","Chunking","Emergent Properties"] },
{ name: "Redundancy & Fault Tolerance", category: "Systems & Change", description: "Backup capacity that preserves function under failure.", connections: ["Resilience","Systems Thinking","Entropy"] },
{ name: "Equilibrium & Disequilibrium", category: "Systems & Change", description: "Balance points versus shifting states in systems.", connections: ["Feedback Loop","Systems Thinking","Entropy"] },
{ name: "Pareto Frontier", category: "Ethics & Reasoning", description: "Set of choices where improving one goal worsens another.", connections: ["Trade-offs","Cost-Benefit Analysis","Opportunity Cost"] },
{ name: "Calibration (Probabilistic)", category: "Knowledge & Communication", description: "Aligning confidence with actual frequencies.", connections: ["Bayesian Reasoning","Hypothesis Testing","Scientific Uncertainty"] }
    ];

    // ========= 2) Deduplicate + build links =========
    const byName = new Map();
    for (const c of conceptsRaw) { if (!byName.has(c.name)) byName.set(c.name, c); }
    const concepts = Array.from(byName.values());

    const valid = new Set(concepts.map(c => c.name));
    const nodes = concepts.map(d => ({ id: d.name, category: d.category, description: d.description }));
    const links = concepts.flatMap(d =>
      (d.connections || [])
        .filter(t => valid.has(t))
        .map(t => ({ source: d.name, target: t }))
    );

    // ========= 3) SVG, pan/zoom =========
    const width = 1700, height = 950;
    const svg = d3.select("#chart").attr("viewBox", [0,0,width,height]);
    const panBg = svg.append("rect").attr("class","pan-bg").attr("x",0).attr("y",0).attr("width",width).attr("height",height).attr("fill","transparent");
    const g = svg.append("g");

    const zoom = d3.zoom()
      .scaleExtent([0.25, 4])
      .filter((event) => {
        if (event.type === "wheel") return true; // allow wheel anywhere
        if (event.type === "mousedown") return event.target.classList.contains("pan-bg"); // drag-pan only on bg
        if (event.type === "touchstart") return event.target.classList.contains("pan-bg");
        return true;
      })
      .on("zoom", (event) => g.attr("transform", event.transform));
    svg.call(zoom);

    panBg.on("mousedown", () => panBg.classed("grabbing", true));
    svg.on("mouseup", () => panBg.classed("grabbing", false));
    svg.on("mouseleave", () => panBg.classed("grabbing", false));

    // ========= 4) Colors, categories, legend =========
    const categories = [...new Set(nodes.map(n => n.category))];
    const color = d3.scaleOrdinal()
      .domain(categories)
      .range(["#2563eb","#f97316","#10b981","#a855f7","#ef4444","#0ea5e9","#facc15","#ec4899","#14b8a6","#6b7280"]);

    const tooltip = d3.select("#tooltip");
    const countEl = document.getElementById("count");
    countEl.textContent = `(${nodes.length})`;

    // Neighbor map
    const getId = v => (typeof v === "object" ? v.id : v);
    const neighbors = new Map(); nodes.forEach(n => neighbors.set(n.id, new Set()));
    links.forEach(l => { const a=getId(l.source), b=getId(l.target); neighbors.get(a).add(b); neighbors.get(b).add(a); });

    // ========= 5) Draw links/nodes/labels =========
    const link = g.append("g")
      .attr("stroke", "#d1d5db")
      .attr("stroke-width", 1.2)
      .selectAll("line")
      .data(links)
      .join("line");

    const node = g.append("g")
      .selectAll("circle")
      .data(nodes)
      .join("circle")
      .attr("r", 16)
      .attr("fill", d => color(d.category))
      .attr("stroke", "#fff")
      .attr("stroke-width", 1.5)
      .on("mouseover", (event, d) => {
        tooltip.style("opacity", 1)
          .html(`<strong>${d.id}</strong><br>${d.category}`)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY + 10) + "px");
      })
      .on("mousemove", (event) => {
        tooltip.style("left", (event.pageX + 10) + "px")
               .style("top", (event.pageY + 10) + "px");
      })
      .on("mouseout", () => tooltip.style("opacity", 0))
      .on("click", (_, d) => showDetails(d))
      .call(d3.drag()
        .on("start", (event, d) => { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
        .on("drag",  (event, d) => { d.fx = event.x; d.fy = event.y; })
        .on("end",   (event, d) => { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
      );

    const label = g.append("g")
      .selectAll("text")
      .data(nodes)
      .join("text")
      .attr("class", "label")
      .attr("text-anchor", "middle")
      .text(d => d.id);

    // ========= 6) Force simulation =========
    const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.id).distance(185))
      .force("charge", d3.forceManyBody().strength(-310))
      .force("center", d3.forceCenter(width/2, height/2))
      .force("collide", d3.forceCollide().radius(34));

    simulation.on("tick", () => {
      link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
      node.attr("cx", d => d.x).attr("cy", d => d.y);
      label.attr("x", d => d.x).attr("y", d => d.y - 18);
    });

    // ========= 7) Legend (click to highlight) =========
    let selectedCategory = null;
    function buildLegend() {
      const legend = d3.select("#legend");
      legend.html("");
      categories.forEach(cat => {
        const item = legend.append("div").attr("class","legend-item");
        item.append("div").attr("class","legend-swatch").style("background", color(cat));
        item.append("div").text(cat);
        item.on("click", () => { selectedCategory = (selectedCategory === cat ? null : cat); searchQuery = ""; syncSearchBox(); updateHighlight(); });
      });
      highlightLegend();
    }
    function highlightLegend() {
      d3.select("#legend").selectAll(".legend-item")
        .style("opacity", (_, i) => (!selectedCategory || selectedCategory === categories[i]) ? 1 : 0.35)
        .style("outline", (_, i) => (selectedCategory === categories[i]) ? "2px solid #9ca3af" : "none");
    }

    // ========= 8) Search (filter + auto-zoom) =========
    let searchQuery = "";
    function syncSearchBox() { const el = document.getElementById("search"); if (el) el.value = searchQuery; }

    function applySearchHighlight() {
      if (!searchQuery) { // nothing searched
        selectedCategory = null;
        updateHighlight();
        return;
      }
      const q = searchQuery.toLowerCase();
      const matched = new Set(nodes.filter(d => d.id.toLowerCase().includes(q) || d.category.toLowerCase().includes(q)).map(d => d.id));
      const nbrs = new Set(); matched.forEach(id => neighbors.get(id)?.forEach(n => nbrs.add(n)));

      node.transition().duration(200).style("opacity", d => (matched.has(d.id) || nbrs.has(d.id)) ? 1 : 0.12);
      label.transition().duration(200).style("opacity", d => (matched.has(d.id) || nbrs.has(d.id)) ? 1 : 0.12);
      link.transition().duration(200)
        .style("opacity", d => (matched.has(getId(d.source)) || matched.has(getId(d.target))) ? 0.9 : 0.08)
        .style("stroke-width", d => (matched.has(getId(d.source)) || matched.has(getId(d.target))) ? 2.2 : 1.0);

      // auto-zoom to matched nodes
      const mNodes = nodes.filter(d => matched.has(d.id));
      if (mNodes.length) {
        const xs = mNodes.map(n => n.x), ys = mNodes.map(n => n.y);
        const minX = Math.min(...xs), maxX = Math.max(...xs);
        const minY = Math.min(...ys), maxY = Math.max(...ys);
        const dx = maxX - minX || 1, dy = maxY - minY || 1;
        const margin = 80;
        const k = Math.min((width - margin*2) / dx, (height - margin*2) / dy, 3);
        const tx = (width - k * (minX + maxX)) / 2;
        const ty = (height - k * (minY + maxY)) / 2;
        svg.transition().duration(450).call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(k));
      }
      highlightLegend();
    }

    function updateHighlight() {
      if (searchQuery) return applySearchHighlight();
      if (!selectedCategory) {
        node.transition().duration(250).style("opacity", 1);
        label.transition().duration(250).style("opacity", 1);
        link.transition().duration(250).style("opacity", 0.9).style("stroke-width", 1.2);
        highlightLegend();
        return;
      }
      const inCat = new Set(nodes.filter(d => d.category === selectedCategory).map(d => d.id));
      const nbrs = new Set(); inCat.forEach(id => neighbors.get(id)?.forEach(n => nbrs.add(n)));
      node.transition().duration(250).style("opacity", d => (inCat.has(d.id) || nbrs.has(d.id)) ? 1 : 0.15);
      label.transition().duration(250).style("opacity", d => (inCat.has(d.id) || nbrs.has(d.id)) ? 1 : 0.15);
      link.transition().duration(250)
        .style("opacity", d => (inCat.has(getId(d.source)) || inCat.has(getId(d.target))) ? 0.9 : 0.12)
        .style("stroke-width", d => (inCat.has(getId(d.source)) || inCat.has(getId(d.target))) ? 2.4 : 1.0);
      highlightLegend();
    }

    function wireSearch() {
      const inp = d3.select("#search");
      const clear = d3.select("#clear-btn");
      let t;
      function handle() {
        searchQuery = (inp.property("value") || "").trim();
        selectedCategory = null;
        applySearchHighlight();
      }
      inp.on("input", () => { clearTimeout(t); t = setTimeout(handle, 200); });
      clear.on("click", () => {
        inp.property("value", "");
        searchQuery = "";
        fitToNodes();
        updateHighlight();
      });
    }

    // ========= 9) Sidebar details =========
    function showDetails(d) {
      const full = concepts.find(c => c.name === d.id);
      const details = d3.select("#details");
      details.html("");
      details.append("h3").text(full?.name || d.id);
      if (full?.category) details.append("p").html(`<strong>Category:</strong> ${full.category}`);
      if (full?.description) details.append("p").text(full.description);
      if (full?.connections?.length) details.append("p").html(`<strong>Connections:</strong> ${full.connections.join(", ")}`);
    }

    // ========= 10) Fit once after initial layout =========
    function fitToNodes() {
      const xs = nodes.map(n => n.x), ys = nodes.map(n => n.y);
      const minX = Math.min(...xs), maxX = Math.max(...xs);
      const minY = Math.min(...ys), maxY = Math.max(...ys);
      const dx = maxX - minX || 1, dy = maxY - minY || 1;
      const margin = 70;
      const k = Math.min((width - margin*2)/dx, (height - margin*2)/dy, 3);
      const tx = (width - k * (minX + maxX)) / 2;
      const ty = (height - k * (minY + maxY)) / 2;
      svg.transition().duration(600).call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(k));
    }

    // Boot
    buildLegend();
    wireSearch();
    setTimeout(fitToNodes, 1200);
  </script>
</body>
</html>
